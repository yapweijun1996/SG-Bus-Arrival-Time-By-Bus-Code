
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Bus Arrival Information</title>
		<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
		<style>
			/* Reset and Base Styles */
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}
			
			body {
				font-family: 'Roboto', sans-serif;
				background: #fff;
				color: #111;
				line-height: 1.6;
				display: flex;
				flex-direction: column;
				align-items: center;
				padding-bottom: 50px;
			}
			
			/* Header Styling */
			header {
				width: 100%;
				background: #000;
				color: #fff;
				padding: 30px 15px;
				text-align: center;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
			}
			
			.header-content h1 {
				font-size: 2rem;
				margin-bottom: 10px;
			}
			
			.header-content p {
				font-size: 1rem;
				opacity: 0.85;
			}
			
			/* Search Section Styling */
			.search-section {
				width: 100%;
				display: flex;
				justify-content: center;
				margin: 30px 0;
			}
			
			.form-container {
				background: #fff;
				padding: 25px;
				border-radius: 10px;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
				width: 90%;
				max-width: 500px;
				border: 1px solid #000;
			}
			
			.search-section form {
				display: flex;
				flex-direction: column;
			}
			
			.search-section label {
				font-weight: 500;
				margin-bottom: 10px;
				color: #111;
			}
			
			.search-section input[type="text"],
			.tag-input {
				padding: 14px 18px;
				font-size: 1rem;
				border: 1px solid #000;
				border-radius: 6px;
				margin-bottom: 20px;
				outline: none;
				transition: border 0.3s ease;
				width: 100%;
			}
			
			.search-section input[type="text"]:focus,
			.tag-input:focus {
				border-color: #555;
			}
			
			.search-section button {
				padding: 14px 18px;
				background-color: #000;
				color: #fff;
				font-size: 1rem;
				font-weight: 500;
				border: none;
				border-radius: 6px;
				cursor: pointer;
				transition: background 0.3s ease, transform 0.2s ease;
			}
			
			.search-section button:hover {
				background-color: #333;
				transform: translateY(-2px);
			}
			
			/* Tag Input Container */
			.tag-container {
				display: flex;
				flex-wrap: wrap;
				align-items: center;
				padding: 8px;
				border: 1px solid #000;
				border-radius: 6px;
				margin-bottom: 20px;
				min-height: 48px;
				cursor: text;
				gap: 6px;
			}
			
			.tag {
				background-color: #ddd;
				border-radius: 6px;
				padding: 8px 12px;
				display: flex;
				align-items: center;
				font-size: 0.95rem;
				min-height: 32px;
				user-select: none;
			}
			
			.tag span {
				margin-left: 8px;
				cursor: pointer;
				font-weight: bold;
				font-size: 1.1rem;
				min-width: 20px;
				min-height: 20px;
				display: flex;
				align-items: center;
				justify-content: center;
			}
			
			.tag-input {
				border: none;
				outline: none;
				flex-grow: 1;
				min-width: 100px;
				font-size: 1rem;
				padding: 4px;
				min-height: 32px;
			}
			
			/* Content Section Styling */
			#content {
				width: 90%;
				max-width: 700px;
				margin-bottom: 50px;
			}
			
			#loading, #error {
				text-align: center;
				font-size: 1.1rem;
				margin: 20px 0;
			}
			
			#error {
				color: #d9534f;
			}
			
			.hidden {
				display: none;
			}
			
			/* Fade-out animation for the loading message */
			.fade-out {
				opacity: 0;
				transition: opacity 1s ease-out;
			}
			
			/* Service Card Styling */
			.service {
				background: #fff;
				padding: 20px;
				margin-bottom: 20px;
				border-radius: 20px;
				border: 1px solid #000;
				box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
			}
			
			.service h2 {
				margin-bottom: 5px;
				font-size: 1.6rem;
				border-bottom: 1px solid #000;
				padding-bottom: 5px;
				color: #000;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			
			.service-table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 10px;
			}
			
			.service-table th, .service-table td {
				padding: 10px;
				border-bottom: 1px solid #ddd;
				text-align: left;
				color: #111;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			
			.service-table th {
				background: #fff;
				font-weight: 500;
				border: 1px solid #000;
				font-size: 1rem;
			}
			
			.success-row {
				background-color: #d4edda!important;
			}
			.legend {
				width: 90%;
				max-width: 700px;
				margin-top: 30px;
				font-size: 0.95rem;
				padding: 10px;
			}
			
			.legend h3 {
				margin-bottom: 10px;
				font-weight: 500;
				border-bottom: 1px solid #000;
				padding-bottom: 5px;
			}
			
			.legend-item {
				margin-bottom: 12px;
			}
			
			.legend-item strong {
				display: block;
				margin-bottom: 4px;
				font-weight: 600;
			}
			
			.legend-item p {
				margin-left: 10px;
				line-height: 1.5;
			}
			
			/* Favorites Section Styling */
			.favorite-item:hover {
				background-color: #e9ecef !important;
			}

			.favorite-btn {
				transition: all 0.2s ease;
			}

			.favorite-btn:hover {
				transform: translateY(-1px);
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
			}

			.current-bus-stop {
				animation: fadeIn 0.3s ease-in;
			}

			@keyframes fadeIn {
				from { opacity: 0; transform: translateY(10px); }
				to { opacity: 1; transform: translateY(0); }
			}

			/* Responsive Adjustments */
			@media (max-width: 600px) {
				.service-table th:nth-child(1),
				.service-table th:nth-child(2),
				.service-table th:nth-child(3),
				.service-table th:nth-child(4),
				.service-table th:nth-child(5),
				.service-table th:nth-child(6),
				.service-table th:nth-child(7) {
					font-size: 3vw;
				}
				.service-table td:nth-child(4),
				.service-table th:nth-child(4),
				.service-table td:nth-child(6),
				.service-table th:nth-child(6),
				.service-table td:nth-child(7),
				.service-table th:nth-child(7) {
					display: none;
				}
				.service-table td:nth-child(1),
				.service-table td:nth-child(2){
					font-size: 5vw;
				}
				.service-table td:nth-child(3),
				.service-table td:nth-child(5){
					font-size: 4vw;
				}

				/* Mobile styles for nearby button */
				#nearbyBtn {
					font-size: 0.9rem !important;
					padding: 12px 20px !important;
					max-width: none !important;
				}
				.legend {
					font-size: 5.5vw;
					line-height: 1.6;
				}
				
				.legend-item p {
					margin-left: 0;
				}
				header {
					padding: 20px 10px;
				}
				.header-content h1 {
					font-size: 1.8rem;
				}
				.form-container {
					padding: 20px;
				}
				.search-section input[type="text"], .tag-input, .search-section button {
					font-size: 1rem;
					padding: 14px 16px;
				}
				
				/* Mobile-optimized tag container */
				.tag-container {
					padding: 10px;
					min-height: 52px;
					gap: 8px;
				}
				
				.tag {
					padding: 10px 14px;
					font-size: 1rem;
					min-height: 40px;
					border-radius: 8px;
				}
				
				.tag span {
					font-size: 1.2rem;
					min-width: 24px;
					min-height: 24px;
					margin-left: 10px;
				}
				
				.tag-input {
					font-size: 1rem;
					min-width: 120px;
					min-height: 40px;
					padding: 6px;
				}
				
				.service {
					padding: clamp(10px, 1.5vw, 15px);
				}
				.service h2 {
					font-size: 6vw;
				}
				.service-table th, .service-table td {
					padding: clamp(2px, 1vw, 8px);
					font-size: 3vw;
				}
			}
			
		</style>
	</head>
	<body>
		<header>
			<div class="header-content">
				<h1>Bus Arrival Information</h1>
				<p>Enter a bus stop ID below to see the upcoming bus arrivals. If left empty, it defaults to 70049. Optionally filter by Bus Service Number using tags. (e.g., add 155 and 135)</p>
			</div>
		</header>
		
		<section class="search-section">
			<div class="form-container">
				<form id="idForm">
					<label for="busId">Bus Stop ID</label>
					<input type="text" id="busId" name="busId" placeholder="70049">

					<label for="busTags">Bus Service Filter (Optional, use tags below)</label>
					<div class="tag-container" id="tagContainer">
						<input type="text" class="tag-input" id="tagInput" placeholder="Type a number and press Enter">
					</div>

					<input type="hidden" id="busNo" name="busNo" value="">
					<input type="hidden" id="filter_bus_no" name="filter_bus_no" value="">

					<button type="submit">Check Arrival</button>

					<!-- Favorites Toggle Button -->
					<div style="margin-top: 15px; text-align: center;">
						<button type="button" id="showFavoritesBtn" style="
							padding: 8px 16px; background-color: #28a745; color: #fff; border: none;
							border-radius: 6px; cursor: pointer; font-size: 0.9rem;
						">‚≠ê Show My Favorites</button>
					</div>
				</form>

				<!-- Current Bus Stop Info and Favorite -->
				<div id="currentBusStopSection" class="current-bus-stop" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd; display: none;">
					<div style="display: flex; justify-content: space-between; align-items: center;">
						<div>
							<strong>Current Bus Stop: <span id="currentBusStopId"></span></strong>
							<div id="currentBusStopName" style="font-size: 0.9rem; color: #666; margin-top: 4px;"></div>
						</div>
						<button id="busStopFavBtn" class="favorite-btn bus-stop-fav-btn" style="
							background: none; border: 1px solid #007bff; color: #007bff; padding: 8px 12px;
							border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
						">ü§ç Add to Favorites</button>
					</div>
				</div>

				<div class="nearby-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center;">
					<p style="margin-bottom: 15px; color: #666; font-size: 0.95rem;">Need to find a bus stop?</p>
					<button type="button" id="nearbyBtn" style="
						padding: 12px 24px;
						background-color: #fff;
						color: #000;
						font-size: 1rem;
						font-weight: 500;
						border: 2px solid #000;
						border-radius: 6px;
						cursor: pointer;
						transition: all 0.3s ease;
						width: 100%;
						max-width: 250px;
					">üìç Find Nearby Bus Stops</button>
				</div>
			</div>
		</section>

	<!-- Favorites Section -->
	<section id="favorites-section" class="favorites-section" style="width: 90%; max-width: 700px; margin: 30px auto; display: none;">
		<div class="favorites-container" style="background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); border: 1px solid #000;">
			<h2 style="margin-bottom: 20px; font-size: 1.5rem; border-bottom: 1px solid #000; padding-bottom: 10px; color: #000;">‚≠ê My Favorites</h2>

			<!-- Bus Stop Favorites -->
			<div class="favorites-group" id="busStopFavorites" style="margin-bottom: 30px;">
				<h3 style="margin-bottom: 15px; font-size: 1.2rem; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Bus Stop Favorites</h3>
				<div id="busStopFavoritesList" style="display: flex; flex-direction: column; gap: 10px;">
					<p style="color: #666; font-style: italic;">No favorite bus stops yet. Search for a bus stop and click the heart icon to add it here.</p>
				</div>
			</div>

			<!-- Bus Service Favorites -->
			<div class="favorites-group" id="busServiceFavorites">
				<h3 style="margin-bottom: 15px; font-size: 1.2rem; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Bus Service Favorites</h3>
				<div id="busServiceFavoritesList" style="display: flex; flex-direction: column; gap: 10px;">
					<p style="color: #666; font-style: italic;">No favorite bus services yet. When you see a bus service in the results, click the heart icon to add it here.</p>
				</div>
			</div>

			<!-- Quick Actions -->
			<div class="favorites-actions" style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center;">
				<button type="button" id="clearAllFavorites" style="padding: 10px 20px; background-color: #dc3545; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Clear All Favorites</button>
				<button type="button" id="toggleFavorites" style="padding: 10px 20px; background-color: #6c757d; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin-left: 10px;">Hide Favorites</button>
			</div>
		</div>
	</section>

	<section id="content">
			<div id="loading">Loading bus arrival data, please wait...</div>
			<div id="error" class="hidden"></div>
			<div id="services"></div>
		</section>
		
		<section id="legend" class="legend">
			<h3>Legend</h3>
			<div class="legend-item">
				<strong>Operator:</strong>
				<p>SBST ‚Äì SBS Transit<br>SMRT ‚Äì SMRT Corporation<br>TTS ‚Äì Tower Transit Singapore<br>GAS ‚Äì Go Ahead Singapore</p>
			</div>
			<div class="legend-item">
				<strong>Load:</strong>
				<p>SEA ‚Äì Seats Available<br>SDA ‚Äì Standing Available<br>LSD ‚Äì Limited Standing</p>
			</div>
			<div class="legend-item">
				<strong>Feature:</strong>
				<p>WAB ‚Äì Wheelchair Accessible Bus</p>
			</div>
			<div class="legend-item">
				<strong>Type:</strong>
				<p>SD ‚Äì Single Deck<br>DD ‚Äì Double Deck<br>BD ‚Äì Bendy</p>
			</div>
		</section>
		
		
		<script>
			// JavaScript from fixed displayServices() function ‚Äî now supports unique rows, adds feature/type columns, avoids duplicate times
			document.addEventListener('DOMContentLoaded', function () {
				const DEFAULT_ID = '70049';
				const POLLING_INTERVAL_MS = 15000; // 15000 = 15 seconds
				const urlParams = new URLSearchParams(window.location.search);

				// localStorage favorites management
				const FAVORITES_KEY = 'sg_bus_favorites';

				function getFavorites() {
					try {
						const favorites = localStorage.getItem(FAVORITES_KEY);
						return favorites ? JSON.parse(favorites) : { busStops: [], busServices: [] };
					} catch (e) {
						console.error('Error loading favorites:', e);
						return { busStops: [], busServices: [] };
					}
				}

				function saveFavorites(favorites) {
					try {
						localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
					} catch (e) {
						console.error('Error saving favorites:', e);
					}
				}

				function addBusStopFavorite(busStopId, busStopName = '') {
					const favorites = getFavorites();
					if (!favorites.busStops.some(stop => stop.id === busStopId)) {
						favorites.busStops.push({ id: busStopId, name: busStopName, dateAdded: new Date().toISOString() });
						saveFavorites(favorites);
						return true;
					}
					return false;
				}

				function removeBusStopFavorite(busStopId) {
					const favorites = getFavorites();
					const initialLength = favorites.busStops.length;
					favorites.busStops = favorites.busStops.filter(stop => stop.id !== busStopId);
					if (favorites.busStops.length < initialLength) {
						saveFavorites(favorites);
						return true;
					}
					return false;
				}

				function addBusServiceFavorite(serviceNo, operator = '') {
					const favorites = getFavorites();
					if (!favorites.busServices.some(service => service.no === serviceNo)) {
						favorites.busServices.push({ no: serviceNo, operator: operator, dateAdded: new Date().toISOString() });
						saveFavorites(favorites);
						return true;
					}
					return false;
				}

				function removeBusServiceFavorite(serviceNo) {
					const favorites = getFavorites();
					const initialLength = favorites.busServices.length;
					favorites.busServices = favorites.busServices.filter(service => service.no !== serviceNo);
					if (favorites.busServices.length < initialLength) {
						saveFavorites(favorites);
						return true;
					}
					return false;
				}

				function isBusStopFavorite(busStopId) {
					const favorites = getFavorites();
					return favorites.busStops.some(stop => stop.id === busStopId);
				}

				function isBusServiceFavorite(serviceNo) {
					const favorites = getFavorites();
					return favorites.busServices.some(service => service.no === serviceNo);
				}

				function renderFavorites() {
					const favorites = getFavorites();
					const favoritesSection = document.getElementById('favorites-section');
					const busStopList = document.getElementById('busStopFavoritesList');
					const busServiceList = document.getElementById('busServiceFavoritesList');

					// Show/hide favorites section based on whether there are any favorites
					if (favorites.busStops.length > 0 || favorites.busServices.length > 0) {
						favoritesSection.style.display = 'block';
					} else {
						favoritesSection.style.display = 'none';
					}

					// Render bus stop favorites
					if (favorites.busStops.length > 0) {
						busStopList.innerHTML = '';
						favorites.busStops.forEach(stop => {
							const stopItem = document.createElement('div');
							stopItem.className = 'favorite-item';
							stopItem.style.cssText = `
								display: flex; justify-content: space-between; align-items: center;
								padding: 12px; background: #f8f9fa; border: 1px solid #ddd;
								border-radius: 6px; margin-bottom: 8px;
							`;

							stopItem.innerHTML = `
								<div class="favorite-info" style="flex-grow: 1;">
									<strong>Bus Stop ${stop.id}</strong>
									${stop.name ? `<br><small style="color: #666;">${stop.name}</small>` : ''}
								</div>
								<div class="favorite-actions" style="display: flex; gap: 8px;">
									<button class="use-favorite-btn" onclick="useFavoriteBusStop('${stop.id}')" style="
										padding: 6px 12px; background: #007bff; color: white; border: none;
										border-radius: 4px; cursor: pointer; font-size: 0.8rem;
									">Use</button>
									<button class="remove-favorite-btn" onclick="removeBusStopFavorite('${stop.id}')" style="
										padding: 6px 12px; background: #dc3545; color: white; border: none;
										border-radius: 4px; cursor: pointer; font-size: 0.8rem;
									">Remove</button>
								</div>
							`;
							busStopList.appendChild(stopItem);
						});
					} else {
						busStopList.innerHTML = '<p style="color: #666; font-style: italic;">No favorite bus stops yet. Search for a bus stop and click the heart icon to add it here.</p>';
					}

					// Render bus service favorites
					if (favorites.busServices.length > 0) {
						busServiceList.innerHTML = '';
						favorites.busServices.forEach(service => {
							const serviceItem = document.createElement('div');
							serviceItem.className = 'favorite-item';
							serviceItem.style.cssText = `
								display: flex; justify-content: space-between; align-items: center;
								padding: 12px; background: #f8f9fa; border: 1px solid #ddd;
								border-radius: 6px; margin-bottom: 8px;
							`;

							serviceItem.innerHTML = `
								<div class="favorite-info" style="flex-grow: 1;">
									<strong>Bus Service ${service.no}</strong>
									${service.operator ? `<br><small style="color: #666;">${service.operator}</small>` : ''}
								</div>
								<div class="favorite-actions" style="display: flex; gap: 8px;">
									<button class="add-filter-btn" onclick="addServiceToFilter('${service.no}')" style="
										padding: 6px 12px; background: #28a745; color: white; border: none;
										border-radius: 4px; cursor: pointer; font-size: 0.8rem;
									">Add Filter</button>
									<button class="remove-favorite-btn" onclick="removeBusServiceFavorite('${service.no}')" style="
										padding: 6px 12px; background: #dc3545; color: white; border: none;
										border-radius: 4px; cursor: pointer; font-size: 0.8rem;
									">Remove</button>
								</div>
							`;
							busServiceList.appendChild(serviceItem);
						});
					} else {
						busServiceList.innerHTML = '<p style="color: #666; font-style: italic;">No favorite bus services yet. When you see a bus service in the results, click the heart icon to add it here.</p>';
					}
				}

				function useFavoriteBusStop(busStopId) {
					document.getElementById('busId').value = busStopId;
					document.getElementById('idForm').dispatchEvent(new Event('submit'));
				}

				function addServiceToFilter(serviceNo) {
					const currentFilter = tags.join(',');
					if (currentFilter && !currentFilter.includes(serviceNo)) {
						tags.push(serviceNo);
						refreshTags();
						document.getElementById('idForm').dispatchEvent(new Event('submit'));
					} else if (!currentFilter.includes(serviceNo)) {
						tags.push(serviceNo);
						refreshTags();
						document.getElementById('idForm').dispatchEvent(new Event('submit'));
					}
				}

				function toggleFavoritesSection() {
					const section = document.getElementById('favorites-section');
					if (section.style.display === 'none') {
						section.style.display = 'block';
						document.getElementById('toggleFavorites').textContent = 'Hide Favorites';
					} else {
						section.style.display = 'none';
						document.getElementById('toggleFavorites').textContent = 'Show Favorites';
					}
				}

				function updateCurrentBusStopDisplay(busStopId, busStopName = '') {
					const section = document.getElementById('currentBusStopSection');
					const idSpan = document.getElementById('currentBusStopId');
					const nameDiv = document.getElementById('currentBusStopName');
					const favBtn = document.getElementById('busStopFavBtn');

					if (busStopId) {
						idSpan.textContent = busStopId;
						nameDiv.textContent = busStopName || '';
						section.style.display = 'block';

						// Update favorite button state
						if (isBusStopFavorite(busStopId)) {
							favBtn.innerHTML = '‚ù§Ô∏è Remove from Favorites';
							favBtn.style.backgroundColor = '#dc3545';
							favBtn.style.color = '#fff';
							favBtn.title = 'Remove from favorites';
						} else {
							favBtn.innerHTML = 'ü§ç Add to Favorites';
							favBtn.style.backgroundColor = '#007bff';
							favBtn.style.color = '#fff';
							favBtn.title = 'Add to favorites';
						}

						// Add event listener for favorite button
						favBtn.onclick = function() {
							if (isBusStopFavorite(busStopId)) {
								removeBusStopFavorite(busStopId);
								favBtn.innerHTML = 'ü§ç Add to Favorites';
								favBtn.style.backgroundColor = '#007bff';
								favBtn.style.color = '#fff';
								favBtn.title = 'Add to favorites';
							} else {
								addBusStopFavorite(busStopId, busStopName);
								favBtn.innerHTML = '‚ù§Ô∏è Remove from Favorites';
								favBtn.style.backgroundColor = '#dc3545';
								favBtn.style.color = '#fff';
								favBtn.title = 'Remove from favorites';
							}
							renderFavorites();
						};
					} else {
						section.style.display = 'none';
					}
				}

				// Make favorite functions globally available for onclick handlers
				window.addBusStopFavorite = addBusStopFavorite;
				window.removeBusStopFavorite = removeBusStopFavorite;
				window.addBusServiceFavorite = addBusServiceFavorite;
				window.removeBusServiceFavorite = removeBusServiceFavorite;
				window.useFavoriteBusStop = useFavoriteBusStop;
				window.addServiceToFilter = addServiceToFilter;
				
				const busIdInput = document.getElementById('busId');
				const filterBusNoInput = document.querySelector("#filter_bus_no");
				const tagContainer = document.getElementById('tagContainer');
				const tagInput = document.getElementById('tagInput');
				const busNoHidden = document.getElementById('busNo');
				const idForm = document.getElementById('idForm');
				const loadingDiv = document.getElementById('loading');
				const errorDiv = document.getElementById('error');
				const servicesDiv = document.getElementById('services');
				
				let pollingInterval;
				let tags = [];
				
				function initialize() {
					const idParam = urlParams.get('busId');
					if (!idParam) {
						busIdInput.value = DEFAULT_ID;
						urlParams.set('busId', DEFAULT_ID);
						window.history.replaceState(null, '', '?' + urlParams.toString());
					} else {
						busIdInput.value = idParam;
					}
					
					const busNoParam = urlParams.get('busNo');
					if (busNoParam) {
						tags = busNoParam.split(',').map(item => item.trim()).filter(item => item);
						refreshTags();
					}
					
					setupEventListeners();
					fetchAndDisplay(busIdInput.value.trim() || DEFAULT_ID, busNoHidden.value);
					pollingInterval = setInterval(() => fetchAndDisplay(busIdInput.value.trim() || DEFAULT_ID, busNoHidden.value), POLLING_INTERVAL_MS);
					renderFavorites(); // Initialize favorites display
				}
				
				function refreshTags() {
					tagContainer.innerHTML = '';
					tags.forEach((tag, index) => {
						const tagElem = document.createElement('div');
						tagElem.className = 'tag';
						tagElem.textContent = tag;
						const removeSpan = document.createElement('span');
						removeSpan.textContent = '√ó';
						removeSpan.onclick = function () {
							tags.splice(index, 1);
							refreshTags();
						};
						tagElem.appendChild(removeSpan);
						tagContainer.appendChild(tagElem);
					});
					tagContainer.appendChild(tagInput);
					busNoHidden.value = tags.join(',');
					if (urlParams.get('filter_bus_no') === 'y') tagInput.focus();
				}
				
				function setupEventListeners() {
					// Nearby bus stops button functionality
					const nearbyBtn = document.getElementById('nearbyBtn');
					nearbyBtn.addEventListener('click', function() {
						window.open('https://yapweijun1996.github.io/Nearby-Bus-Stop-v2/', '_blank');
					});

					// Hover effects for nearby button
					nearbyBtn.addEventListener('mouseenter', function() {
						this.style.backgroundColor = '#000';
						this.style.color = '#fff';
						this.style.transform = 'translateY(-2px)';
					});

					nearbyBtn.addEventListener('mouseleave', function() {
						this.style.backgroundColor = '#fff';
						this.style.color = '#000';
						this.style.transform = 'translateY(0)';
					});

					// Favorites management buttons
					document.getElementById('toggleFavorites').addEventListener('click', toggleFavoritesSection);
					document.getElementById('showFavoritesBtn').addEventListener('click', function() {
						const section = document.getElementById('favorites-section');
						if (section.style.display === 'none' || section.style.display === '') {
							renderFavorites(); // Refresh favorites display
							section.style.display = 'block';
							this.textContent = '‚≠ê Hide My Favorites';
						} else {
							section.style.display = 'none';
							this.textContent = '‚≠ê Show My Favorites';
						}
					});
					document.getElementById('clearAllFavorites').addEventListener('click', function() {
						if (confirm('Are you sure you want to clear all favorites?')) {
							localStorage.removeItem(FAVORITES_KEY);
							renderFavorites();
						}
					});

					tagInput.addEventListener('keydown', function (e) {
						if (e.key === 'Enter' || e.key === ',') {
							e.preventDefault();
							filterBusNoInput.value = 'y';
							const value = tagInput.value.trim();
							if (value && !tags.includes(value)) {
								tags.push(value);
								refreshTags();
								idForm.submit();
							}
							tagInput.value = '';
						} else if (e.key === 'Backspace' && tagInput.value === '' && tags.length > 0) {
							tags.pop();
							refreshTags();
						}
					});

					tagContainer.addEventListener('click', () => tagInput.focus());

					idForm.addEventListener('submit', function (event) {
						event.preventDefault();
						
						// Auto-add tag input text as filter if present
						const tagInputValue = tagInput.value.trim();
						if (tagInputValue && !tags.includes(tagInputValue)) {
							tags.push(tagInputValue);
							refreshTags();
							tagInput.value = '';
						}
						
						const newId = busIdInput.value.trim() || DEFAULT_ID;
						const newBusNo = busNoHidden.value.trim();
						const filterBusNo = filterBusNoInput.value.trim() || 'n';
						
						urlParams.set('filter_bus_no', filterBusNo);
						urlParams.set('busId', newId);
						if (newBusNo) urlParams.set('busNo', newBusNo);
						else urlParams.delete('busNo');
						
						window.history.pushState(null, '', '?' + urlParams.toString());
						
						servicesDiv.innerHTML = '';
						errorDiv.classList.add('hidden');
						loadingDiv.textContent = 'Loading bus arrival data, please wait...';
						loadingDiv.classList.remove('hidden');
						
						clearInterval(pollingInterval);
						pollingInterval = setInterval(() => fetchAndDisplay(newId, newBusNo), POLLING_INTERVAL_MS);
						fetchAndDisplay(newId, newBusNo);
					});
					
					window.addEventListener('beforeunload', () => clearInterval(pollingInterval));
				}
				
				function fetchAndDisplay(busId, busNoFilter) {
					loadingDiv.classList.remove('hidden');
					loadingDiv.textContent = 'Loading bus arrival data, please wait...';
					errorDiv.classList.add('hidden');
					
					fetch(`https://arrivelah2.busrouter.sg/?id=${encodeURIComponent(busId)}`)
					.then(response => response.ok ? response.json() : Promise.reject('Network response was not ok'))
					.then(data => {
						loadingDiv.classList.add('hidden');
						displayServices(data, busNoFilter, busId);
						// Update current bus stop display after successful data fetch
						updateCurrentBusStopDisplay(busId, data.bus_stop_id ? `Bus Stop ${data.bus_stop_id}` : '');
					})
					.catch(error => {
						loadingDiv.classList.add('hidden');
						errorDiv.textContent = 'Error: ' + error;
						errorDiv.classList.remove('hidden');
					});
				}
				
				function displayServices(data, busNoFilter, currentBusId) {
					servicesDiv.innerHTML = '';
					if (!data.services || data.services.length === 0) {
						servicesDiv.innerHTML = '<p style="text-align:center;">No bus arrivals found at this stop.</p>';
						return;
					}

					const filterArray = busNoFilter ? busNoFilter.split(',').map(item => item.trim()) : [];
					const favorites = getFavorites();

					// Separate favorite and non-favorite services
					const favoriteServices = [];
					const regularServices = [];

					data.services.forEach(service => {
						if (filterArray.length > 0 && !filterArray.includes(service.no)) return;

						if (favorites.busServices.some(fav => fav.no === service.no)) {
							favoriteServices.push(service);
						} else {
							regularServices.push(service);
						}
					});

					// Combine arrays: favorites first, then regular services
					const sortedServices = [...favoriteServices, ...regularServices];

					sortedServices.forEach(service => {
						const seen = new Set();
						const serviceContainer = document.createElement('div');
						serviceContainer.className = 'service';
						serviceContainer.setAttribute('data-id', service.no);

						// Add visual styling for favorite services
						const serviceIsFavorite = favorites.busServices.some(fav => fav.no === service.no);
						if (serviceIsFavorite) {
							serviceContainer.style.border = '2px solid #ffc107';
							serviceContainer.style.backgroundColor = '#fffbf0';
						}

						// Create header with favorite button for bus service
						const header = document.createElement('h2');
						header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;';

						const headerText = document.createElement('span');
						const headerIsFavorite = favorites.busServices.some(fav => fav.no === service.no);
						headerText.innerHTML = `
							<strong>${service.no}</strong> from ${service.operator}
							<br><small style="font-size: 0.8rem; color: #666; font-weight: normal;">Bus Stop: ${currentBusId}</small>
							${headerIsFavorite ? '<br><small style="font-size: 0.7rem; color: #ffc107; font-weight: bold;">‚≠ê Favorite</small>' : ''}
						`;
						header.appendChild(headerText);

						// Add favorite button for bus service
						const serviceFavBtn = document.createElement('button');
						serviceFavBtn.className = 'favorite-btn service-fav-btn';
						serviceFavBtn.innerHTML = isBusServiceFavorite(service.no) ? '‚ù§Ô∏è' : 'ü§ç';
						serviceFavBtn.title = isBusServiceFavorite(service.no) ? 'Remove from favorites' : 'Add to favorites';
						serviceFavBtn.style.cssText = `
							background: none; border: none; font-size: 1.2rem; cursor: pointer;
							padding: 4px 8px; border-radius: 4px; transition: background-color 0.2s;
						`;
						serviceFavBtn.onclick = function(e) {
							e.stopPropagation();
							if (isBusServiceFavorite(service.no)) {
								removeBusServiceFavorite(service.no);
								this.innerHTML = 'ü§ç';
								this.title = 'Add to favorites';
							} else {
								addBusServiceFavorite(service.no, service.operator);
								this.innerHTML = '‚ù§Ô∏è';
								this.title = 'Remove from favorites';
							}
							renderFavorites();
						};
						header.appendChild(serviceFavBtn);

						serviceContainer.appendChild(header);
						
						const table = document.createElement('table');
						table.className = 'service-table';
						const headerRow = document.createElement('tr');
						['Time', 'Duration', 'Load', 'Feature', 'Type', 'Info', 'Tracked'].forEach(text => {
							const th = document.createElement('th');
							th.textContent = text;
							headerRow.appendChild(th);
						});
						table.appendChild(headerRow);
						
						const tripLabels = {
							next: 'First Bus Arrival',
							subsequent: 'Next Bus Arrival',
							next2: 'Second Bus Arrival',
							next3: 'Third Bus Arrival'
						};
						
						Object.entries(tripLabels).forEach(([key, label]) => {
							const tripData = service[key];
							if (!tripData) return;
							
							const timeKey = `${tripData.time}_${tripData.duration_ms}`;
							if (seen.has(timeKey)) return;
							seen.add(timeKey);
							
							const row = document.createElement('tr');
							const time = new Date(tripData.time);
							const formattedTime = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
							const durationMin = Math.ceil(tripData.duration_ms / 60000);
							const durationText = durationMin <= 1 ? 'Arrived' : durationMin + ' min';
							
							row.innerHTML = `
							<td title="${time.toISOString()}">${formattedTime}</td>
							<td>${durationText}</td>
							<td title="${tripData.load}">${tripData.load}</td>
							<td>${tripData.feature || '-'}</td>
							<td>${tripData.type || '-'}</td>
							<td style="font-size: 0.85rem">${label}</td>
							<td title="Tracked via GPS or backend system">${tripData.monitored ? 'Yes' : 'No'}</td>
							`;
							
							if (tripData.monitored) row.classList.add('success-row');
							table.appendChild(row);
						});
						
						serviceContainer.appendChild(table);
						servicesDiv.appendChild(serviceContainer);
						
						document.querySelectorAll('.service').forEach(service => {
							service.addEventListener('click', function () {
								const busNo = this.getAttribute('data-id');
								console.log(`Fetching data for Service ${busNo}`);
								
								this.style.transition = 'background-color 0.5s ease-in-out';
								this.style.backgroundColor = 'black';
								
								this.querySelectorAll('*').forEach(child => {
									child.style.transition = 'background-color 0.3s ease-in-out';
									child.style.backgroundColor = 'black';
								});
								
								setTimeout(() => {
									fetchAndDisplay(busIdInput.value.trim() || DEFAULT_ID, busNoHidden.value);
								}, 600);
							});
						});
					});
				}
				
				initialize();
			});
		</script>
	</body>
</html>
